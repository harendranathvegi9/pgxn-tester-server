{% extends "base.html" %}
{% block content %}

				<h1 class="page-header">{{title}}</h1>

				<div class="table-responsive">
					<form class="form-inline" role="form">
						<table class="table table-striped" id="results">
							<thead>
								<tr>
									<th>date</th>
									<th>distribution</th>
									<th>version</th>
									<th>status</th>
									<th>machine</th>
									<th>PostgreSQL</th>
									<th>install</th>
									<th>load</th>
									<th>check</th>
									<th>&nbsp;</th>
								</tr>
								<tr>
									<th>&nbsp;</th>
									<th><input type="text" class="form-control input-sm" id="distribution-name"></th>
									<th><input type="text" class="form-control input-sm" style="width: 7em" id="version-number"></th>
									<th>
										<select class="form-control input-sm" id="distribution-status">
											<option></option>
											<option>stable</option>
											<option>testing</option>
											<option>unstable</option>
										</select>
									</th>
									<th><input type="text" class="form-control input-sm" id="machine-name"></th>
									<th><input type="text" class="form-control input-sm" style="width: 5em" id="postgres-version"></th>
									<th><a href="#" class="btn btn-sm btn-primary" id="filter-button">Filter</a></th>
									<th>&nbsp;</th>
									<th>&nbsp;</th>
									<th>&nbsp;</th>
								</tr>
							</thead>
							<tbody>
								<!-- loaded by AJAX -->
							</tbody>
						</table>
					</div>
				</div>
{% endblock %}

{% block script %}
	<script type="text/JavaScript">

		var filters = {
			{% for name in filters %}'{{name}}' : '{{filters[name]}}', {% endfor %}
		};

		$(document).ready(function () {

			$.get('http://api.pgxn-tester.org/results', filters, function (data, status, xhr) {

				var phases = ['install', 'load', 'check'];

				for (d in data) {
					var row = $('<tr></tr>')
					row.append('<td>' + data[d].test_date + '</td>');
					row.append('<td><a href="/distributions/' + data[d].dist + '" class="dist-link">' + data[d].dist + '</a></td>');
					row.append('<td><a href="/distributions/' + data[d].dist + '/' + data[d].version + '" class="version-link">' + data[d].version + '</a></td>');
					row.append('<td>' + data[d].status + '</td>');
					row.append('<td><a href="/machines/' + data[d].machine+ '" class="machine-link">' + data[d].machine + '</a></td>');
					row.append('<td>' + data[d].pg_version + '</td>');

					for (p in phases) {
					
						var phase = phases[p];

						if (data[d][phase] == 'ok')
							row.append('<td><span class="btn btn-xs bg-success">ok</span></td>');
						else if (data[d][phase] == 'error')
							row.append('<td><span class="btn btn-xs bg-danger">error</span></td>');
						else if (data[d][phase] == 'missing')
							row.append('<td><span class="btn btn-xs bg-warning">missing</span></td>');
						else
							row.append('<td>&nbsp;</td>');
					}

					row.append('<td><a class="btn btn-primary btn-xs active" role="button" href="/results/' + data[d].uuid + '" class="result-link">details</a></td>');
					$('#results').append(row);
				}
			});

			$('#filter-button').click(function () {

				filters = {};

				if ($('#distribution-name').val() != '')
					filters['distribution'] = $('#distribution-name').val();

				if ($('#version-number').val() != '')
					filters['version'] = $('#version-number').val();

				if ($('#distribution-status').val() != '')
					filters['status'] = $('#distribution-status').val();

				if ($('#machine-name').val() != '')
					filters['machine'] = $('#machine-name').val();

				if ($('#postgres-version').val() != '')
					filters['pg_version'] = $('#postgres-version').val();

				$.get('http://api.pgxn-tester.org/results', filters, function (data, status, xhr) {

					$('#results tbody').empty();

					var phases = ['install', 'load', 'check'];

					for (d in data) {
						var row = $('<tr></tr>')
						row.append('<td>' + data[d].test_date + '</td>');
						row.append('<td><a href="/distributions/' + data[d].dist + '" class="dist-link">' + data[d].dist + '</a></td>');
						row.append('<td><a href="/distributions/' + data[d].dist + '/' + data[d].version + '" class="version-link">' + data[d].version + '</a></td>');
						row.append('<td>' + data[d].status + '</td>');
						row.append('<td><a href="/machines/' + data[d].machine+ '" class="machine-link">' + data[d].machine + '</a></td>');
						row.append('<td>' + data[d].pg_version + '</td>');

						for (p in phases) {
						
							var phase = phases[p];

							if (data[d][phase] == 'ok')
								row.append('<td><span class="btn btn-xs bg-success">ok</span></td>');
							else if (data[d][phase] == 'error')
								row.append('<td><span class="btn btn-xs bg-danger">error</span></td>');
							else if (data[d][phase] == 'missing')
								row.append('<td><span class="btn btn-xs bg-warning">missing</span></td>');
							else
								row.append('<td>&nbsp;</td>');
						}

						row.append('<td><a class="btn btn-primary btn-xs active" role="button" href="/results/' + data[d].uuid + '" class="result-link">details</a></td>');
						$('#results tbody').append(row);
					}
				});

			});

		});
	
	</script>
{% endblock %}